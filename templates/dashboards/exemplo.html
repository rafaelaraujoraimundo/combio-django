{% extends 'menu/index.html'%}
{% block content %}
{% load static %}

<script src={% static "js/charts.js" %}></script>
<script src="{% static 'chartkick/chartkick.js' %}"></script>

<div class="container">

    
    
    {{ chart_teste }}

    <canvas id="chart2"></canvas>

<script>
  // Dados fornecidos
  var ANO_MES = ['2023-04', '2023-04', '2023-04', '2023-04', '2023-04', '2023-05', '2023-05', '2023-05'];
  var Fila = ['TI::N2::Fluig', 'TI::N2::Diversos', 'TI::N2::Hardware', 'TI::N2::Software',
              'TI::N3::Projetos::Melhorias', 'TI::N2::Fluig', 'TI::N2::Diversos', 'TI::N2::Datasul/Protheus'];
  var Abertos = [96, 18, 13, 7, 3, 107, 22, 147];
  var Fechados = [95, 18, 12, 7, 2, 99, 19, 135];

  // Agrupando os dados por "ANO_MES" e "Fila"
  var dadosAgrupados = {};
  for (var i = 0; i < ANO_MES.length; i++) {
    var anoMes = ANO_MES[i];
    var fila = Fila[i];
    var chave = anoMes + "_" + fila;

    if (!dadosAgrupados[chave]) {
      dadosAgrupados[chave] = { abertos: 0, fechados: 0 };
    }

    dadosAgrupados[chave].abertos += Abertos[i];
    dadosAgrupados[chave].fechados += Fechados[i];
  }

  // Convertendo os dados agrupados em formato adequado para o Chart.js
  var labels = Array.from(new Set(ANO_MES));
  var datasets = [];

  var filas = Array.from(new Set(Fila));
  for (var i = 0; i < filas.length; i++) {
    var fila = filas[i];
    var dadosFilaAbertos = [];
    var dadosFilaFechados = [];

    for (var j = 0; j < labels.length; j++) {
      var anoMes = labels[j];
      var chave = anoMes + "_" + fila;
      dadosFilaAbertos.push(dadosAgrupados[chave] ? dadosAgrupados[chave].abertos : 0);
      dadosFilaFechados.push(dadosAgrupados[chave] ? dadosAgrupados[chave].fechados : 0);
    }

    datasets.push({
      label: fila + ' (Abertos)',
      data: dadosFilaAbertos,
      backgroundColor: "rgba(75, 192, 192, 0.5)",
      stack: "Stack " + i
    });

    datasets.push({
      label: fila + ' (Fechados)',
      data: dadosFilaFechados,
      backgroundColor: "rgba(192, 75, 75, 0.5)",
      stack: "Stack " + i
    });
  }

  // Plugin personalizado para renderizar os valores das colunas
  var valuePlugin = {
    id: 'valueLabels',
    afterDatasetsDraw: function(chart) {
      var ctx = chart.ctx;

      chart.data.datasets.forEach(function(dataset, datasetIndex) {
        var meta = chart.getDatasetMeta(datasetIndex);

        if (!meta.hidden) {
          meta.data.forEach(function(element, index) {
            // Renderiza o valor apenas para colunas visíveis
            if (element._model.width > 0) {
              var data = dataset.data[index];
              ctx.fillStyle = 'black';
              ctx.font = 'bold 12px Arial';
              ctx.textAlign = 'center';
              ctx.fillText(data, element._model.x, element._model.y - 10);
            }
          });
        }
      });
    }
  };

  // Configurando o gráfico
  var ctx = document.getElementById("chart2").getContext("2d");
  var chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: datasets
    },
    options: {
      responsive: true,
      scales: {
        x: {
          grid: {
            display: false
          },
          stacked: true,
          ticks: {
            maxRotation: 90,
            minRotation: 90
          }
        },
        y: {
          beginAtZero: true,
          stacked: true,
          ticks: {
            stepSize: 50
          }
        }
      },
      plugins: {
        // Adiciona o plugin personalizado
        valueLabels: valuePlugin
      }
    }
  });
</script>
        {% endblock content %}